Одржавајмо у сваком тренутку граф са следећим особинама:

- Постоје три врсте чворова, "унутрашњи", "листови" и један специјалан "празан" чвор. Унутрашњи чворови имају тачно две излазне гране, које ћемо звати "левом" и "десном". Листови немају излазне гране и чувају једну целобројну вредност, коју ћемо звати "лабела".
- Граф је "непроменљив", односно, није могуће изменити особине постојећих чворова. Могуће је само додавати нове чворове.
- Сваки чвор чува величину из њега достижног дела графа. За листове, ова величина износи $1$. За унутрашње чворове, ова величина једнака је збиру величина чворова до којих се стиже помоћу леве и десне гране. За празан чвор ова величина је $0$.
- Аналогно дефинишемо достижни низ лабела за неки чвор. За листове, то је низ од једног елемента - његова лабела. За унутрашње чворове низ се добија конкатенацијом низова левог и десног чвора. За празан чвор је празан низ.

Поред графа, одржавајмо и показивач $R$ на чвор чији ће достижни низ лабела бити једнак тренутној вредности низа $a$. Упите типа $2$ решавамо веома једноставно, крећемо из чвора $R$ и спуштамо се лево или десно у зависности од тога ком елементу низа желимо да приступимо, све док не дођемо до листа. 

Упите првог типа решавамо помоћу следећих операција над графом:

- `seci(x, s)`, враћа два показивача на чворове, где је први чвор такав да је његов достижни низ једнак префиксу достижног низа за чвор $x$ дужине $s$, а достижни низ другог чвора је једнак остатку достижног низа за чвор $x$.
- `spoji(x, y)` враћа чвор чији је достижни низ једнак конкатенацији достижних низова за чворове $x$ и $y$. Ова операција се може извести на два начина о чему ће бити више речи касније.
- `pomnozi(x, k)` враћа чвор чији је достижни низ једнак конкатенацији $k$ достижних низова за чвор $x$. 

Наш циљ је да све три операције раде брзо. Тачније, све три операције радиће у сложености линеарној по дубини графа почев од датог чвора или чворова, зато ће нама бити циљ да се ова дубина не повећава превише у току рада.

Следе скице могућих реализација ове три операције:

- `seci(x, s)`, уколико је $s$ мање од величине левог чвора од $x$, правимо копију $y$ чвора $x$ чији леви чвор сечемо рекурзивно. Први чвор резултата рекурзивног позива вратимо као први чвор, док други чвор резултата рекурзивног позива закачимо као леви чвор чвора $y$ и као други чвор вратимо управо $y$. У супротном, аналогно сечемо десни чвор.
- `spoji(x, y)`, насумично изаберемо један од та два чвора (рецимо да је то чвор $x$), направимо његову копију $z$, рекурзивно спојимо десни чвор чвора $z$ и чвор $y$ и резултат закачимо као десни чвор $z$, затим вратимо $z$.
- `pomnozi(x, k)`, како ће важити $k \leq n < 2^{20}$, направимо чворове $y_0, y_1, \ldots, y_{19}$, где је $y_0$ копија чвора $x$, а за $i > 0$ је $y_i$ чвор који се добија "простим" (нерекурзивним) спајањем чвора $y_{i-1}$ са самим собом. Тачније, чвору $y_i$ ће и лева и десна грана показивати на чвор $y_{i-1}$. Сада је јасно да је низ чвора $y_i$ једнак конкатенацији $2^i$ низова чвора $x$. Затим само изаберемо степене двојке у бинарном запису броја $k$ и поново простим спајањем направимо резултујући чвор, водећи рачуна да спајамо од мањих ка већим степенима.

Сада, задатак решавамо на следећи начин. Граф иницијализујемо као бинарно стабло чији листови редом имају лабеле од $1$ до $N$ и $R$ постављамо за корен тог стабла. У већини случајева само сечемо делове низа за чвор $R$ и састављамо их у неком другом редоследу. Једини незгодан случај јесте тај када је $u > v$ и $l > u-v$. Тада се једно парче оригиналног низа циклично понавља одређен број пута, и ту нам је потребна ефикасна операција `pomnozi`.

Једна могућа оптимизација јесте да, када број чворова пребаци неку унапред задату границу (рецимо пар милиона), израчунамо цео достижан низ из чвора $R$, обришемо све чворове и "почнемо испочетка" са тим низом.

Временска и меморијска сложеност: $N + Q \log N$.